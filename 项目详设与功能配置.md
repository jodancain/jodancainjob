# RemoteDev iOS Skeleton 项目详设与功能配置

本文件基于 `ios/` 目录下的 SwiftUI 工程骨架，对整体架构、关键功能、运行配置与可扩展性策略进行详细设计说明，方便快速落地到真实的 Xcode 项目中。

## 1. 系统概览

RemoteDev iOS Skeleton 是一个面向远程开发/AI 协作场景的 SwiftUI App。它包含两个主要流程：

1. **连接流程**：通过 HTTP 探活与 WebSocket 握手建立与远端代理的会话，并缓存主机信息。
2. **聊天/命令流程**：在稳定连接基础上，支持终端命令、文件传输、AI 问答与 AI 代理模式的交互。

整体状态由 `AppState` 统一管理：当连接状态变更时（`ConnectionStatus`），根视图自动在 `ConnectView` 与 `ChatView` 之间切换。

## 2. 架构分层

```
ios/
├── App/                # AppState、RootView 以及依赖注入
├── Features/           # 按功能切分的 SwiftUI 模块
│   ├── Connect/        # 连接视图与 ViewModel
│   └── Chat/           # 聊天界面、消息展示、命令解析
├── Models/             # 领域模型：连接配置、命令包、消息、附件
├── Networking/         # HTTP 测试、文件上传、WebSocket 管理
└── Utils/              # UserDefaults 持久化工具
```

- **数据流**：用户输入 → `ViewModel` 更新 → `AppState/ConnectionManager` → 网络层 → 服务端事件回流 → `NotificationCenter` → `ChatViewModel`。
- **状态管理**：所有视图通过 `@EnvironmentObject var appState` 与网络状态保持同步，避免重复请求。

## 3. 关键模块设计

### 3.1 AppState (`ios/App/AppEnvironment.swift`)
- 持有 `ConnectionConfig`、`ConnectionStatus` 与 `sessionId`。
- 在初始化时从 `ConnectionCredentialsStore` 读取最近的 Host/Port/Username 并自动填充。
- 实现 `ConnectionManagerDelegate`：接收状态与服务端事件广播，并通过 `NotificationCenter.connectionManagerEvent` 将事件分发给聊天模块。

### 3.2 Connect 模块
- **ViewModel (`Features/Connect/ConnectViewModel.swift`)**：
  - 维护表单字段、测试结果、错误提示。
  - 将输入字段回写到 `appState.serverConfig`，确保连接按钮与测试按钮共享同一配置。
  - `testConnection()`：调用 `ConnectionManager.testConnection`，用于 HTTP 探活。
  - `connect()`：触发 WebSocket 连接，成功后调用 `persistIfNeeded()` 把凭据缓存。
- **视图 (`Features/Connect/ConnectView.swift`)**：
  - 使用 `Form` 划分服务器配置、账号、状态与动作区域。
  - 自动显示实时状态颜色与错误消息，并监听 `connectionStatus` 变化。

### 3.3 Chat 模块
- **ViewModel (`Features/Chat/ChatViewModel.swift`)**：
  - 监听 `NotificationCenter.connectionManagerEvent` 以处理 `ServerEvent`（包含终端输出、AI 增量、下载链接、工具日志等）。
  - `sendCurrentMessage()`：
    1. 使用 `CommandParser` 解析输入，构建 `CommandPayload`（区分终端、下载、上传通知、AI QA、AI Agent）。
    2. 负责附件上传：在 `/upload to` 命令时先调用 `ConnectionManager.uploadFile()` 拿到 `fileId` 与远端路径，再发送指令。
    3. 通过 `ConnectionManager.send()` 将 `CommandEnvelope` 序列化成 JSON 并发送到 WebSocket。
  - `attachMockFile()`：用于在无文件选择器权限时模拟附件上传。
- **视图 (`Features/Chat/ChatView.swift` & `MessageBubbleView.swift`)**：
  - 顶部状态条展示当前连接和 `headerTitle`。
  - 主体通过 `LazyVStack` 渲染 `ChatMessage`，并根据 `MessageKind`（文本、终端输出、工具日志、下载）选择样式。
  - 底部输入区包含 AI 模式菜单、文件选择、`TextEditor` 与发送按钮，绑定 `viewModel` 的状态。

### 3.4 Networking 层
- **`HttpClient`**：封装 URLSession 测试连接、上传文件，支持 Basic Auth 与 multipart/form-data 构建器。
- **`WebSocketClient`**：管理 `URLSessionWebSocketTask` 的连接、关闭与消息循环，向 `ConnectionManager` 回调。
- **`ConnectionManager`**：
  - 统一 HTTP 与 WebSocket API，对 `AppState` 暴露简单的方法。
  - 把 WebSocket 数据转换成强类型 `ServerEvent` 并交给 delegate；维护 `sessionId`。

### 3.5 持久化工具 (`Utils/ConnectionCredentialsStore.swift`)
- 使用 `UserDefaults` 保存最近一次成功的 Host/Port/Username。
- 提供 `save` 与 `load`，初始化 AppState 时即加载。

## 4. 功能解释与交互流程

| 功能 | 用户入口 | 关键逻辑 | 服务端交互 | 结果 |
| --- | --- | --- | --- | --- |
| HTTP 测试连接 | Connect 页面「测试连接」按钮 | `ConnectViewModel.testConnection()` 调用 `HttpClient.testConnection` | `GET /api/test-connection` | 更新 `statusText`、`testResult`、错误信息 |
| 建立 WebSocket | Connect 页面「连接」按钮 | `ConnectionManager.connect()` 生成 `wss://host:port/ws` 请求 | WebSocket 握手，带 Basic Auth | `connectionStatus` 变为 `connected`，`AppState` 切换到 Chat |
| 终端命令发送 | Chat 输入框（默认模式） | `CommandParser` 生成 `commandType = terminal` | `client_command` 消息经 WebSocket 下发 | `messages` 追加 user 气泡，并等待 `terminal_output` 事件 |
| 下载指令 | 输入 `/download <path>` | Parser 设置 `commandType = download` | WebSocket | 收到 `download_ready` 事件 → 展示下载链接 |
| 上传指令 | 输入 `/upload to <path>` 并选择文件 | ChatViewModel 先调用 `uploadFile`，成功后 `commandType = upload_notify` | HTTP 上传接口 + WebSocket 通知 | 系统消息提示上传结果，服务器可消费 fileId |
| AI 问答 | 通过 AI 菜单选择「AI 问答」并输入文本 | Parser 生成 `commandType = ai_qa`，附加语言选项 | WebSocket → 后端 AI | 收到 `assistant_delta` / `assistant_message_done`，逐步合并显示 |
| AI 代理 | 菜单选择「AI 代理」 | Parser 生成 `commandType = ai_agent`，包含 `goal`、`constraints` | WebSocket | 工具日志 `tool_log` + AI 输出 |

## 5. 配置与部署

### 5.1 Xcode / iOS 运行环境
- **最低 iOS 版本**：17.0（`Deployment Target`）。
- **Xcode**：15.4+，Swift 5.9。
- **Bundle Identifier & Signing**：按照 `xcode的项目配置指南.md` 设置 Team、Bundle ID，确保签名合法。
- **Capabilities**：若需要 ATS 例外（连接非 HTTPS 服务），在 Info.plist 中添加 `NSAppTransportSecurity > NSAllowsArbitraryLoads = YES`（仅限开发）。

### 5.2 网络配置
- 默认通过 HTTPS + WSS，端口可配置。
- Basic Auth：`ConnectionConfig.basicAuthHeader` 自动生成，确保服务端支持。
- WebSocket 路径固定为 `/ws`，若后端不同可在 `ConnectionConfig.websocketURL` 中修改。
- HTTP API 路径：
  - `/api/test-connection`
  - `/api/files/upload`

### 5.3 本地持久化
- `UserDefaults` 键：`remote_dev_credentials`，仅缓存 host/port/username，不存储密码。

### 5.4 可扩展性建议
- **更多命令类型**：在 `CommandType` 和 `CommandParser` 中新增 case，并在 `ChatViewModel.sendCurrentMessage()` 与 `ConnectionManager.handleIncomingData` 中对接。
- **鉴权策略**：若需要 Token/Session，可扩展 `ConnectionConfig` 并在 `HttpClient`/`ConnectionManager` 中填充 header。
- **UI 定制**：`MessageKind` 与 `MessageBubbleView` 可扩充更多 UI 形态（代码块、图片预览等）。
- **存储策略**：将 `ConnectionCredentialsStore` 换为 Keychain 以增强安全性。

## 6. 运行校验步骤
1. 在 Connect 页面填写服务器地址与账号密码，点击「测试连接」确保 HTTP 正常。
2. 点击「连接」，成功后自动跳转到 Chat 页并显示绿色状态。
3. 在输入框输入命令或自然语言：
   - 普通命令：直接发送，观察终端输出。
   - `/download /path/file`：收到下载链接后点击 `Link` 下载。
   - `/upload to /remote/path`：点回形针选择文件（或调用 `attachMockFile()`），再发送确认。
   - AI 模式：通过菜单选择 QA/Agent 并输入内容，查看 AI 增量输出。
4. 如需断开，点击顶部右侧「断开」。

## 7. 文件清单与职责速查

| 文件 | 主要职责 |
| --- | --- |
| `App/AppEnvironment.swift` | AppState、连接状态监听、凭据持久化 |
| `App/RemoteDevApp.swift` | 应用入口、RootView 路由 |
| `Features/Connect/ConnectView(.swift)` | 连接 UI + 状态展示 |
| `Features/Connect/ConnectViewModel.swift` | 表单状态、HTTP 测试、连接与缓存 |
| `Features/Chat/ChatView(.swift)` | 聊天 UI、AI 菜单、附件选择 |
| `Features/Chat/ChatViewModel.swift` | 消息发送、命令解析、附件上传、事件处理 |
| `Features/Chat/CommandParser.swift` | 解析文本生成 `CommandPayload` |
| `Features/Chat/MessageBubbleView.swift` | 消息展示组件 |
| `Models/*.swift` | 连接配置、消息/命令/附件数据结构 |
| `Networking/HttpClient.swift` | 测试连接、文件上传、Multipart 构建 |
| `Networking/WebSocketClient.swift` | WebSocket 连接与循环收发 |
| `Networking/ConnectionManager.swift` | HTTP+WS 管理、事件解码分发 |
| `Utils/ConnectionCredentialsStore.swift` | UserDefaults 保存主机信息 |

通过以上详设与配置指南，可快速理解并运行 RemoteDev iOS Skeleton，在此基础上扩展业务逻辑或接入真实后端。
